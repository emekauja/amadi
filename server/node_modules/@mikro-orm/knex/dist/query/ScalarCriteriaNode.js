"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ScalarCriteriaNode = void 0;
const core_1 = require("@mikro-orm/core");
const internal_1 = require("./internal");
class ScalarCriteriaNode extends internal_1.CriteriaNode {
    static create(metadata, entityName, payload, parent, key) {
        const node = new ScalarCriteriaNode(metadata, entityName, parent, key);
        node.payload = payload;
        return node;
    }
    process(qb, alias) {
        if (this.shouldJoin()) {
            const nestedAlias = qb.getAliasForEntity(this.entityName, this) || qb.getNextAlias();
            const field = `${alias}.${this.prop.name}`;
            if (this.prop.reference === core_1.ReferenceType.MANY_TO_MANY) {
                qb.join(field, nestedAlias, undefined, 'pivotJoin', this.getPath());
            }
            else {
                qb.join(field, nestedAlias, undefined, 'leftJoin', this.getPath());
            }
            if (this.prop.reference === core_1.ReferenceType.ONE_TO_ONE) {
                qb.addSelect(field);
            }
        }
        return this.payload;
    }
    shouldJoin() {
        if (!this.parent || !this.prop || [core_1.ReferenceType.SCALAR, core_1.ReferenceType.ONE_TO_MANY].includes(this.prop.reference)) {
            return false;
        }
        if (this.prop.reference === core_1.ReferenceType.ONE_TO_ONE) {
            return !this.prop.owner;
        }
        return this.prop.reference === core_1.ReferenceType.MANY_TO_MANY;
    }
}
exports.ScalarCriteriaNode = ScalarCriteriaNode;
//# sourceMappingURL=ScalarCriteriaNode.js.map